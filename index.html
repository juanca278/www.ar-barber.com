<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR-BARBER</title>
  
  <!-- Font Awesome para íconos -->
  <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.4.0/css/all.css">
  
  <!-- Firebase (versión compat para la forma clásica) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- SheetJS para exportación a Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* Estilos generales, header, formularios y secciones */
    * { box-sizing: border-box; }
    body {
      font-family: "Times New Roman", serif;
      margin: 0;
      padding: 0;
      background: #121212;
      color: #fff;
    }
    header {
      background: #000;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      border-bottom: 2px solid #D4AF37;
    }
    header img { max-height: 80px; }
    header h1 { margin: 0; color: #D4AF37; font-size: 2em; }
    nav {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    nav button {
      background: #D4AF37;
      color: #121212;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.3s;
      min-width: 120px;
      text-align: center;
    }
    nav button:hover { background: #b0892c; }
    .container {
      width: 90%;
      max-width: 1200px;
      margin: auto;
      padding: 20px 0;
    }
    section {
      background: #1e1e1e;
      padding: 30px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    .hidden { display: none; }
    form {
      background: #2c2c2c;
      padding: 20px;
      border: 1px solid #D4AF37;
      border-radius: 10px;
      max-width: 500px;
      margin: auto;
    }
    form input, form button, form select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 1em;
      border: 1px solid #D4AF37;
      border-radius: 5px;
      background: #121212;
      color: #fff;
    }
    fieldset {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #D4AF37;
      border-radius: 10px;
    }
    fieldset legend { padding: 0 10px; }
    /* Estilo para checkboxes */
    fieldset label {
      display: inline-flex;
      align-items: center;
      margin-right: 10px;
      font-size: 1em;
    }
    fieldset label input[type="checkbox"] { margin-right: 5px; }
    .hours-container {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .hours-container button {
      width: 80px;
      font-size: 0.9em;
      padding: 8px;
      border: 1px solid #D4AF37;
      border-radius: 5px;
      background: #121212;
      color: #fff;
      transition: background 0.3s;
    }
    .hours-container button.selected {
  background: #444 !important;
  border: 2px solid #fff !important;
}

    .hours-container button[disabled] {
      text-decoration: line-through;
      color: gray;
    }
    #btnAcceptAppointment {
      background: #D4AF37;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      color: #121212;
      font-size: 1em;
      cursor: pointer;
      margin-top: 15px;
    }
    #btnAcceptAppointment:disabled { background: #444; cursor: not-allowed; }
    .home-container {
      text-align: center;
      padding: 30px;
      background: linear-gradient(45deg, #000, #333);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    .home-container h2 { color: #D4AF37; font-size: 2.5em; margin-bottom: 10px; }
    .home-container p { font-size: 1.2em; margin-bottom: 10px; }
    .contact-info p { margin: 5px; font-size: 1em; }
    .contact-info a {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: #D4AF37;
      text-decoration: none;
      font-weight: bold;
      margin: 0 10px;
    }
    .contact-info a:hover { text-decoration: underline; }
    #userAppointments {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    #userAppointments h2 { text-align: center; color: #D4AF37; }
    .user-appointment {
      background: #121212;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #D4AF37;
      border-radius: 5px;
    }
    .user-appointment p { margin: 5px 0; font-size: 0.95em; }
    /* Modal para editar citas */
    #editModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #editModal .modal-content {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.8);
    }
    .modal-buttons button { margin-right: 10px; }
    select#editTime option:disabled {
      text-decoration: line-through;
      color: gray;
    }
    
    /* ==============================
       Estilos para botones en el área de administración (todos en tonos grises)
       ============================== */
    #adminPanel button, 
    #adminBreakSection button, 
    #blockedUsersContainer button {
      background-color: gray !important;
      color: #fff !important;
      border: none;
      padding: 8px 12px;
      border-radius: 3px;
      cursor: pointer;
      margin: 5px;
    }
  </style>
</head>
<body>
  <header>
    <img src="imagen.jpg" alt="Logo de AR-BARBER">
    <h1>AR-BARBER</h1>
    <nav>
      <button id="btnHome">Inicio</button>
      <button id="btnClient">Agendar Cita</button>
      <button id="btnUserAppointments">Mis Citas</button>
      <button id="btnAdmin">Administrador</button>
    </nav>
  </header>
  
  <div class="container">
    <!-- Sección de Inicio -->
    <section id="home">
      <div class="home-container">
        <h2>Bienvenido a AR-BARBER</h2>
        <p>
          Transforma tu imagen con nuestro toque personal. Con pasión y dedicación te ayudamos a descubrir tu mejor versión. ¡Vive la experiencia y siente la diferencia en cada corte!
        </p>
        <div class="contact-info">
          <p><strong>Contacto:</strong> Tel: 6688366047 | 6683241804 | Email: info@elestilobarberia.com</p>
          <p>
            <a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
            <a href="https://wa.me/6688366047" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
            <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook-f"></i> Facebook</a>
          </p>
        </div>
      </div>
    </section>
    
    <!-- Sección de Agendar Cita -->
    <section id="clientSection" class="hidden">
      <h2>Reservar Cita</h2>
      <form id="clientForm">
        <label for="clientName">Nombre y Apellido:</label>
        <input type="text" id="clientName" required>
        
        <label for="clientPhone">Número de WhatsApp:</label>
        <input type="tel" id="clientPhone" required>
        
        <label for="clientDate">Seleccione un día:</label>
        <input type="date" id="clientDate" required>
        
        <label for="cutType">Servicio:</label>
        <select id="cutType" required>
          <option value="">--Seleccione un servicio--</option>
          <option value="corte">Corte de cabello ($120)</option>
          <option value="barba">Barba ($100)</option>
          <option value="ceja">Ceja ($30)</option>
          <option value="marcado">Marcado ($70)</option>
          <option value="corte_barba">Corte y barba (Combo) ($200)</option>
          <option value="corte_cera">Corte y cera (Combo) ($220)</option>
          <option value="barba_aceite">Barba y aceite (Combo) ($220)</option>
          <option value="corte_barba_aceite">Corte, barba y aceite (Combo) ($320)</option>
        </select>
        
        <fieldset>
          <legend>Productos disponibles:</legend>
          <label for="product1"><input type="checkbox" id="product1" value="Cera"> Cera ($120)</label>
          <label for="product2"><input type="checkbox" id="product2" value="Aceite p/barba"> Aceite p/barba ($150)</label>
          <label for="product3"><input type="checkbox" id="product3" value="Monóxidil"> Monóxidil ($300)</label>
          <label for="product4"><input type="checkbox" id="product4" value="Shampoo"> Shampoo ($250)</label>
          <label for="product5"><input type="checkbox" id="product5" value="Gel c/tinte"> Gel c/tinte ($100)</label>
        </fieldset>
        <button type="submit">Continuar</button>
      </form>
      <div id="hoursSection" class="hidden">
        <h3>Horas disponibles para <span id="selectedDate"></span>:</h3>
        <div class="hours-container" id="hoursContainer"></div>
        <button id="btnAcceptAppointment" disabled>Aceptar cita</button>
      </div>
      <div id="clientMessage"></div>
      <button id="btnClientBack">Volver</button>
    </section>
    
    <!-- Sección de "Mis Citas" -->
    <section id="userAppointments" class="hidden">
      <h2>Mis Citas</h2>
      <div id="userAppointmentsContainer"></div>
      <button id="btnUserAppointmentsBack">Volver</button>
    </section>
    
    <!-- Sección de Login del Administrador -->
    <section id="adminLogin" class="hidden">
      <h2>Acceso Administrador</h2>
      <form id="loginForm">
        <label for="adminUser">Usuario:</label>
        <input type="text" id="adminUser" required>
        <label for="adminPass">Contraseña:</label>
        <input type="password" id="adminPass" required>
        <button type="submit">Ingresar</button>
      </form>
      <div id="loginMessage"></div>
      <button id="btnAdminBack">Volver</button>
    </section>
    
    <!-- Panel de Administración -->
    <section id="adminPanel" class="hidden">
      <h2>Panel de Administración</h2>
      <div id="adminContainer"></div>
      <button id="btnTomarDescanso">Tomar Descanso</button>
      <div id="totalCorte"></div>
      <button id="btnVisitCount">Excel</button>
      <button id="btnAdminExit">Cerrar sesión</button>
    </section>
    
    <!-- Sección para programar descanso desde Admin de forma dinámica -->
    <section id="adminBreakSection" class="hidden">
      <h2>Programar Descanso</h2>
      <label for="adminBreakDate">Seleccione un día:</label>
      <input type="date" id="adminBreakDate">
      <div id="breakHoursSection" class="hidden">
        <h3>Horas disponibles para <span id="adminBreakSelectedDate"></span>:</h3>
        <div class="hours-container" id="breakHoursContainer"></div>
        <!-- Botón para confirmar múltiples descansos -->
        <button id="confirmBreaksBtn">Confirmar Descansos</button>
      </div>
      <button id="btnAdminBreakBack">Volver</button>
    </section>
  </div>
  
  <!-- Modal para Modificar Cita (Administrador/Cliente) -->
  <!-- En este modal, el cliente (desde "Mis Citas") podrá modificar tanto la fecha como la hora -->
  <div id="editModal" class="hidden">
    <div class="modal-content">
      <h2>Modificar Cita</h2>
      <form id="editForm">
        <label for="editDate">Fecha:</label>
        <input type="date" id="editDate" required>
        <label for="editTime">Hora:</label>
        <select id="editTime" required>
          <option value="">--Seleccione la hora--</option>
        </select>
        <label for="editCutType">Servicio:</label>
        <select id="editCutType" required>
          <option value="">--Seleccione un servicio--</option>
          <option value="corte">Corte de cabello ($120)</option>
          <option value="barba">Barba ($100)</option>
          <option value="ceja">Ceja ($30)</option>
          <option value="marcado">Marcado ($70)</option>
          <option value="corte_barba">Corte y barba (Combo) ($200)</option>
          <option value="corte_cera">Corte y cera (Combo) ($220)</option>
          <option value="barba_aceite">Barba y aceite (Combo) ($220)</option>
          <option value="corte_barba_aceite">Corte, barba y aceite (Combo) ($320)</option>
        </select>
        <fieldset>
          <legend>Productos disponibles:</legend>
          <label for="editProduct1"><input type="checkbox" id="editProduct1" value="Cera"> Cera ($120)</label>
          <label for="editProduct2"><input type="checkbox" id="editProduct2" value="Aceite p/barba"> Aceite p/barba ($150)</label>
          <label for="editProduct3"><input type="checkbox" id="editProduct3" value="Monóxidil"> Monóxidil ($300)</label>
          <label for="editProduct4"><input type="checkbox" id="editProduct4" value="Shampoo"> Shampoo ($250)</label>
          <label for="editProduct5"><input type="checkbox" id="editProduct5" value="Gel c/tinte"> Gel c/tinte ($100)</label>
        </fieldset>
        <div class="modal-buttons">
          <button type="button" id="saveChanges"><i class="fas fa-save"></i> Guardar cambios</button>
          <button type="button" id="deleteAppointment">Cancelar cita</button>
        </div>
        <button type="button" id="closeEditModal" style="margin-top:10px;">Cerrar</button>
      </form>
    </div>
  </div>
  
  <script>
    /* ==============================
       Funciones Auxiliares para Fechas (Horario Local)
       ============================== */
    function getLocalDateString(date) {
      const d = date instanceof Date ? date : new Date(date);
      const year = d.getFullYear();
      const month = (d.getMonth() + 1).toString().padStart(2, "0");
      const day = d.getDate().toString().padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
    
    function parseLocalDate(dateStr) {
      const [year, month, day] = dateStr.split("-").map(Number);
      return new Date(year, month - 1, day);
    }
    
    /* ==============================
       Función para Generar Franjas según Intervalo
       ============================== */
    function generateTimeSlots(start, end, step = 30) {
      const [startHour, startMin] = start.split(":").map(Number);
      const [endHour, endMin] = end.split(":").map(Number);
      const slots = [];
      let totalMinutes = startHour * 60 + startMin;
      const endTotal = endHour * 60 + endMin;
      while(totalMinutes <= endTotal) {
        let hour = Math.floor(totalMinutes / 60);
        let minute = totalMinutes % 60;
        let label = `${hour.toString().padStart(2, "0")}:${minute.toString().padStart(2, "0")}`;
        slots.push(label);
        totalMinutes += step;
      }
      return slots;
    }
    
    // Franjas de servicio
    const morningSlots = generateTimeSlots("09:30", "12:30", 30);
    const afternoonSlots = generateTimeSlots("15:00", "19:30", 30);
    const serviceSlots = morningSlots.concat(afternoonSlots);
    
    /* ==============================
       Configuración Firebase y Datos Globales
       ============================== */
    const firebaseConfig = {
      apiKey: "AIzaSyAuCecYVh9CiAlW6dWNrZuzuLq2DETtq1k",
      authDomain: "ar-barber.firebaseapp.com",
      projectId: "ar-barber",
      storageBucket: "ar-barber.firebasestorage.app",
      messagingSenderId: "663202339677",
      appId: "1:663202339677:web:441b1abf0d0ff5034966b4",
      measurementId: "G-3WBEMN22HX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Generar ID único de dispositivo
    let deviceId = localStorage.getItem("deviceId");
    if (!deviceId) {
      deviceId = "device_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("deviceId", deviceId);
    }
    
    // Precios y Credenciales
    const servicePrices = {
      "corte": 120,
      "barba": 100,
      "ceja": 30,
      "marcado": 70,
      "corte_barba": 200,
      "corte_cera": 220,
      "barba_aceite": 220,
      "corte_barba_aceite": 320
    };
    const productPrices = {
      "Cera": 120,
      "Aceite p/barba": 150,
      "Monóxidil": 300,
      "Shampoo": 250,
      "Gel c/tinte": 100
    };
    const adminCredentials = { user: "admin", pass: "admin123" };
    
    let appointments = [];       // Se actualizará en tiempo real
    let clientData = {};         // Datos al agendar cita
    let selectedHour = null;     // Horario seleccionado en agendar cita
    let currentEditingIndex = null; // Índice para editar cita
    
    // Variable para almacenar múltiples franjas de descanso seleccionadas
    let selectedBreakSlots = [];
    
    /* ==============================
       Función para Bloqueo y Mensajes
       ============================== */
    async function getBlockedData() {
      const doc = await db.collection("blockedDevices").doc(deviceId).get();
      return doc.exists ? doc.data() : null;
    }
    
    async function showRemainingDaysMessage() {
      const blockedData = await getBlockedData();
      if (blockedData) {
        if (blockedData.unblockedAt) {
          let unblockedDate = new Date(blockedData.unblockedAt);
          let availableTime = unblockedDate.getTime() + 10 * 24 * 3600 * 1000;
          let remaining = Math.ceil((availableTime - new Date().getTime()) / (24 * 3600 * 1000));
          return remaining > 0 ? `Te quedan ${remaining} día(s) para poder agendar una cita.` : "";
        } else {
          return "Tu dispositivo está bloqueado. Contacta al administrador.";
        }
      }
      return "";
    }
    
    // Sincronización en tiempo real
    db.collection("appointments").onSnapshot((snapshot) => {
      appointments = [];
      snapshot.forEach(doc => {
        let data = doc.data();
        data.id = doc.id;
        appointments.push(data);
      });
      if (!document.getElementById("adminPanel").classList.contains("hidden")) {
        renderAdminPanel();
      }
      if (!document.getElementById("userAppointments").classList.contains("hidden")) {
        renderUserAppointments();
      }
    });
    
    function showSection(sectionId) {
      document.querySelectorAll("section").forEach(sec => sec.classList.add("hidden"));
      document.getElementById(sectionId).classList.remove("hidden");
    }
    
    // Navegación
    document.getElementById("btnHome").addEventListener("click", () => showSection("home"));
    document.getElementById("btnClient").addEventListener("click", async () => {
      document.getElementById("clientForm").reset();
      document.getElementById("clientMessage").textContent = "";
      let msg = await showRemainingDaysMessage();
      if (msg) document.getElementById("clientMessage").textContent = msg;
      document.getElementById("hoursSection").classList.add("hidden");
      selectedHour = null;
      showSection("clientSection");
    });
    document.getElementById("btnClientBack").addEventListener("click", () => showSection("home"));
    document.getElementById("btnAdmin").addEventListener("click", () => showSection("adminLogin"));
    document.getElementById("btnAdminBack").addEventListener("click", () => showSection("home"));
    document.getElementById("btnUserAppointments").addEventListener("click", async () => {
      await renderUserAppointments();
      showSection("userAppointments");
    });
    document.getElementById("btnUserAppointmentsBack").addEventListener("click", () => showSection("home"));
    
    async function isDeviceBlocked() {
      const doc = await db.collection("blockedDevices").doc(deviceId).get();
      if (doc.exists) {
        const data = doc.data();
        if (!data.unblockedAt) return true;
        let unblockedAt = new Date(data.unblockedAt);
        let diff = new Date() - unblockedAt;
        return diff < 10 * 24 * 60 * 60 * 1000;
      }
      return false;
    }
    
    /* ==============================
       AGENDAR CITA: Renderizar Franjas Horarias
       ============================== */
    function renderAvailableHours(date) {
      const container = document.getElementById("hoursContainer");
      container.innerHTML = "";
      const now = new Date();
      const todayStr = getLocalDateString(new Date());
      const selectedDateObj = parseLocalDate(date);
      const todayObj = parseLocalDate(todayStr);
    
      serviceSlots.forEach((hour) => {
        const [h, m] = hour.split(":").map(Number);
        const slotTime = new Date(selectedDateObj.getFullYear(), selectedDateObj.getMonth(), selectedDateObj.getDate(), h, m, 0);
        const existsNormal = appointments.some(app => app.date === date && app.time === hour && !app.isBreak);
        const existsBreak = appointments.some(app => app.date === date && app.time === hour && app.isBreak === true);
        let disable = existsNormal || existsBreak;
        if (selectedDateObj < todayObj) {
          disable = true;
        } else if (date === todayStr && (now > slotTime || now > new Date(slotTime.getTime() - 15 * 60 * 1000))) {
          disable = true;
        }
        const btn = document.createElement("button");
        btn.textContent = disable ? hour + " (No disponible)" : hour;
        if (disable) {
          btn.disabled = true;
          btn.style.textDecoration = "line-through";
          btn.style.color = "gray";
        } else {
          btn.addEventListener("click", function () {
            const btns = container.querySelectorAll("button");
            btns.forEach((b) => b.classList.remove("selected"));
            this.classList.add("selected");
            selectedHour = hour;
            document.getElementById("btnAcceptAppointment").disabled = false;
          });
        }
        container.appendChild(btn);
      });
    }
    
    async function addAppointment(appointment) {
      try {
        await db.collection("appointments").add(appointment);
      } catch (error) {
        console.error("Error agregando la cita:", error);
      }
    }
    
    document.getElementById("clientForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      if (await isDeviceBlocked()) {
        document.getElementById("clientMessage").textContent = "Este dispositivo está bloqueado de agendar citas. Contacta al administrador.";
        return;
      }
      const name = document.getElementById("clientName").value;
      const date = document.getElementById("clientDate").value;
      const phone = document.getElementById("clientPhone").value;
      const cutType = document.getElementById("cutType").value;
      const products = Array.from(document.querySelectorAll("#clientForm input[type=checkbox]:checked")).map((cb) => cb.value);
      if (!date) { document.getElementById("clientMessage").textContent = "Debe seleccionar una fecha."; return; }
      if (!cutType) { document.getElementById("clientMessage").textContent = "Debe seleccionar el servicio."; return; }
      clientData = { name, date, phone, selectedProducts: products, cutType };
      document.getElementById("selectedDate").textContent = date;
      document.getElementById("hoursSection").classList.remove("hidden");
      renderAvailableHours(date);
      document.getElementById("btnAcceptAppointment").disabled = true;
    });
    
    document.getElementById("btnAcceptAppointment").addEventListener("click", function () {
      if (!selectedHour) return;
      reserveHour(clientData.name, clientData.date, selectedHour, clientData.selectedProducts, clientData.cutType, clientData.phone);
      document.getElementById("clientForm").reset();
      clientData = {};
      selectedHour = null;
    });
    
    function reserveHour(name, date, hour, products, cutType, phone) {
      let price = servicePrices[cutType] || 0;
      products.forEach((p) => { price += productPrices[p] || 0; });
      const newAppointment = {
        name,
        date,
        time: hour,
        products,
        cutType,
        phone,
        monto: price,
        estatus: "Próximo corte",
        createdAt: new Date().toISOString(),
        deviceId: deviceId,
      };
      addAppointment(newAppointment);
      document.getElementById("clientMessage").textContent =
        `Cita reservada para el ${date} a las ${hour}. Servicio: ${cutType}. Productos: ${products.join(", ") || "Ninguno"}. Precio: $${price}.`;
      renderAvailableHours(date);
      setTimeout(() => showSection("home"), 10000);
    }
    
    /* ==============================
       MIS CITAS
       ============================== */
    function createUserAppointmentElement(app) {
      if (app.isBreak) return;
      const container = document.createElement("div");
      container.classList.add("user-appointment");
      if (app.estatus === "Cita cancelada por el administrador" || app.estatus === "Cita cancelada por el cliente") {
        container.innerHTML = `<p><strong>Cita Cancelada</strong></p>
                               <p><strong>Fecha:</strong> ${app.date}</p>
                               <p><strong>Cancelación:</strong> ${app.canceledAt || "No especificado"}</p>`;
        return container;
      }
      container.innerHTML = `<p><strong>Nombre:</strong> ${app.name}</p>
                             <p><strong>Teléfono:</strong> ${app.phone || "No especificado"}</p>
                             <p><strong>Fecha:</strong> ${app.date}</p>
                             <p><strong>Hora:</strong> ${app.time}</p>
                             <p><strong>Servicio:</strong> ${app.cutType || "Sin especificar"}</p>
                             <p><strong>Productos:</strong> ${app.products && app.products.length > 0 ? app.products.join(", ") : "Ninguno"}</p>
                             <p><strong>Ingreso:</strong> $${app.monto}</p>
                             <p><strong>Estatus:</strong> ${app.estatus}</p>`;
      const apptTime = new Date(app.date + "T" + app.time);
      const diffHours = (apptTime - new Date()) / (3600 * 1000);
      if (diffHours < 2 || app.estatus === "Vino" || app.estatus === "No vino") {
        const btnEdit = document.createElement("button");
        btnEdit.innerHTML = '<i class="fas fa-pencil-alt"></i> Editar cita';
        btnEdit.disabled = true;
        btnEdit.title = "No se puede editar esta cita.";
        container.appendChild(btnEdit);
    
        const btnCancel = document.createElement("button");
        btnCancel.innerHTML = '<i class="fas fa-times"></i> Cancelar cita';
        btnCancel.disabled = true;
        btnCancel.title = "No se puede cancelar esta cita.";
        btnCancel.style.marginLeft = "5px";
        container.appendChild(btnCancel);
      } else {
        const btnEdit = document.createElement("button");
        btnEdit.innerHTML = '<i class="fas fa-pencil-alt"></i> Editar cita';
        btnEdit.addEventListener("click", () => openEditModalForClient(app));
        container.appendChild(btnEdit);
    
        const btnCancel = document.createElement("button");
        btnCancel.innerHTML = '<i class="fas fa-times"></i> Cancelar cita';
        btnCancel.style.marginLeft = "5px";
        btnCancel.addEventListener("click", () => cancelClientAppointment(app));
        container.appendChild(btnCancel);
      }
      return container;
    }
    
    async function renderUserAppointments() {
      const container = document.getElementById("userAppointmentsContainer");
      container.innerHTML = "";
      const msg = await showRemainingDaysMessage();
      if (msg) {
        const p = document.createElement("p");
        p.textContent = msg;
        p.style.color = "red";
        container.appendChild(p);
      }
      const userApps = appointments.filter(app => app.deviceId === deviceId && !app.isBreak);
      if (!userApps.length) {
        container.innerHTML += "<p>No tienes citas registradas en este dispositivo.</p>";
        return;
      }
      userApps.forEach(app => {
        const elem = createUserAppointmentElement(app);
        if (elem) container.appendChild(elem);
      });
    }
    
    function cancelClientAppointment(app) {
      if (confirm("¿Desea cancelar esta cita?")) {
        db.collection("appointments").doc(app.id).update({
          estatus: "Cita cancelada por el cliente",
          canceledAt: new Date().toISOString()
        });
      }
    }
    
    /* ==============================
       Función auxiliar para aplicar tachado vía texto combinante
       ============================== */
    function strikeText(text) {
      return text.split("").map(c => c + "\u0336").join("");
    }
    
    /* ==============================
       Modal de Edición y Funciones para Editar Citas
       ============================== */
    function updateEditTimeOptions(selectedDate, currentTimeSelection) {
      const selectEl = document.getElementById("editTime");
      selectEl.innerHTML = "<option value=''>--Seleccione la hora--</option>";
      const todayStr = getLocalDateString(new Date());
      const selectedDateObj = new Date(selectedDate);
      const todayObj = parseLocalDate(todayStr);
      
      serviceSlots.forEach(hour => {
        let isBooked = appointments.some((app, index) => {
          if (index === currentEditingIndex) return false;
          return app.date === selectedDate && app.time === hour &&
                 app.estatus !== "Cita cancelada por el administrador" &&
                 app.estatus !== "Cita cancelada por el cliente";
        });
        const opt = document.createElement("option");
        opt.value = hour;
        let optionText = hour;
        const slotTime = new Date(selectedDate + "T" + hour);
        if (selectedDateObj < todayObj) {
          opt.disabled = true;
          optionText = hour + " (No disponible)";
          opt.textContent = strikeText(optionText);
        } else if (selectedDate === todayStr && new Date() > new Date(slotTime.getTime() - 15 * 60 * 1000)) {
          opt.disabled = true;
          optionText = hour + " (No disponible)";
          opt.textContent = strikeText(optionText);
        } else if (isBooked) {
          opt.disabled = true;
          optionText = hour + " (Ya reservado)";
          opt.textContent = strikeText(optionText);
        } else {
          opt.textContent = hour;
          if (hour === currentTimeSelection) {
            opt.selected = true;
          }
        }
        selectEl.appendChild(opt);
      });
    }
    
    document.getElementById("editDate").addEventListener("change", function() {
      updateEditTimeOptions(this.value, null);
    });
    
    function openEditModalForClient(app) {
      currentEditingIndex = appointments.findIndex(a => a.id === app.id);
      document.getElementById("editDate").value = app.date;
      updateEditTimeOptions(app.date, app.time);
      document.getElementById("editCutType").value = app.cutType;
      ["editProduct1", "editProduct2", "editProduct3", "editProduct4", "editProduct5"].forEach(id => {
        document.getElementById(id).checked = false;
      });
      (app.products || []).forEach(prod => {
        if (prod === "Cera") document.getElementById("editProduct1").checked = true;
        if (prod === "Aceite p/barba") document.getElementById("editProduct2").checked = true;
        if (prod === "Monóxidil") document.getElementById("editProduct3").checked = true;
        if (prod === "Shampoo") document.getElementById("editProduct4").checked = true;
        if (prod === "Gel c/tinte") document.getElementById("editProduct5").checked = true;
      });
      document.getElementById("editModal").style.display = "flex";
    }
    
    document.getElementById("saveChanges").addEventListener("click", async function() {
      let updatedDate = document.getElementById("editDate").value;
      let updatedTime = document.getElementById("editTime").value;
      let updatedCutType = document.getElementById("editCutType").value;
      let updatedProducts = Array.from(document.querySelectorAll("#editForm input[type=checkbox]:checked")).map(cb => cb.value);
      const updateObj = { date: updatedDate, time: updatedTime, cutType: updatedCutType, products: updatedProducts };
      let app = appointments[currentEditingIndex];
      await db.collection("appointments").doc(app.id).update(updateObj);
      document.getElementById("editModal").style.display = "none";
    });
    
    document.getElementById("deleteAppointment").addEventListener("click", async function() {
      if (confirm("¿Desea cancelar esta cita?")) {
        let app = appointments[currentEditingIndex];
        await db.collection("appointments").doc(app.id).update({
          estatus: "Cita cancelada por el cliente",
          canceledAt: new Date().toISOString()
        });
        document.getElementById("editModal").style.display = "none";
      }
    });
    
    document.getElementById("closeEditModal").addEventListener("click", function() {
      document.getElementById("editModal").style.display = "none";
    });
    
    /* ==============================
       Sección: Administración
       ============================== */
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const user = document.getElementById("adminUser").value.trim();
      const pass = document.getElementById("adminPass").value.trim();
      if (user === adminCredentials.user && pass === adminCredentials.pass) {
        showSection("adminPanel");
        renderAdminPanel();
      } else {
        document.getElementById("loginMessage").textContent = "Usuario o contraseña incorrectos.";
      }
    });
    
    document.getElementById("btnAdminExit").addEventListener("click", () => {
      document.getElementById("adminUser").value = "";
      document.getElementById("adminPass").value = "";
      document.getElementById("loginMessage").textContent = "";
      showSection("home");
    });
    
    function renderAdminPanel() {
      const container = document.getElementById("adminContainer");
      container.innerHTML = "";
      const upcomingApps = appointments.filter(app => app.estatus === "Próximo corte");
      upcomingApps.forEach(app => {
        const div = document.createElement("div");
        div.classList.add("appointment");
        div.innerHTML = `
          <p><strong>Nombre:</strong> ${app.name}</p>
          <p><strong>Teléfono:</strong> ${app.phone || "No especificado"}</p>
          <p><strong>Fecha:</strong> ${app.date}</p>
          <p><strong>Hora:</strong> ${app.time}</p>
          <p><strong>Servicio:</strong> ${app.cutType || "Sin especificar"}</p>
          <p><strong>Productos:</strong> ${app.products && app.products.length > 0 ? app.products.join(", ") : "Ninguno"}</p>
          <p><strong>Monto:</strong> $${app.monto}</p>
          <p><strong>Estatus:</strong> ${app.estatus}</p>
        `;
        const apptTime = new Date(app.date + "T" + app.time);
        const diffHours = (apptTime - new Date()) / (3600 * 1000);
        const disableButtons = diffHours < 2 || app.estatus === "Vino" || app.estatus === "No vino";
        
        const btnEdit = document.createElement("button");
        btnEdit.innerHTML = '<i class="fas fa-pencil-alt"></i> Editar cita';
        if (disableButtons) {
          btnEdit.disabled = true;
          btnEdit.title = "No se puede editar esta cita.";
        } else {
          btnEdit.addEventListener("click", () => openEditModalForClient(app));
        }
        div.appendChild(btnEdit);
        
        const btnCancel = document.createElement("button");
        btnCancel.innerHTML = '<i class="fas fa-ban"></i> Cancelar cita';
        btnCancel.style.marginLeft = "5px";
        btnCancel.style.background = "gray";
        if (disableButtons) {
          btnCancel.disabled = true;
          btnCancel.title = "No se puede cancelar esta cita.";
        } else {
          btnCancel.addEventListener("click", async () => {
            await db.collection("appointments").doc(app.id).update({
              estatus: "Cita cancelada por el administrador",
              canceledAt: new Date().toISOString()
            });
            alert("Cita cancelada por el administrador.");
            checkAndBlockDevice(app.deviceId);
            renderAdminPanel();
          });
        }
        div.appendChild(btnCancel);
        
        const btnVino = document.createElement("button");
        btnVino.innerHTML = '<i class="fas fa-check-circle"></i> Vino';
        btnVino.addEventListener("click", async () => {
          await db.collection("appointments").doc(app.id).update({ estatus: "Vino" });
          alert("Cita marcada como 'Vino'.");
          renderAdminPanel();
        });
        div.appendChild(btnVino);
        
        const btnNoVino = document.createElement("button");
        btnNoVino.innerHTML = '<i class="fas fa-times-circle"></i> No vino';
        btnNoVino.style.background = "gray";
        btnNoVino.addEventListener("click", async () => {
          await db.collection("appointments").doc(app.id).update({ estatus: "No vino" });
          alert("Cita marcada como 'No vino'.");
          checkAndBlockDevice(app.deviceId);
          renderAdminPanel();
        });
        div.appendChild(btnNoVino);
        
        container.appendChild(div);
      });
      renderBlockedUsers();
    }
    
    async function checkAndBlockDevice(deviceId) {
      let count = appointments.filter(app => app.deviceId === deviceId && !app.isBreak &&
                          (app.estatus === "No vino" || app.estatus === "Cita cancelada por el administrador")).length;
      if (count >= 3) {
        const blockRef = db.collection("blockedDevices").doc(deviceId);
        const doc = await blockRef.get();
        if (!doc.exists) {
          await blockRef.set({
            deviceId: deviceId,
            blockedAt: new Date().toISOString(),
            cancelCount: count,
            status: "blocked"
          });
          alert("El dispositivo ha sido bloqueado por acumular 3 cancelaciones.");
        }
      }
    }
    
    async function renderBlockedUsers() {
      let container = document.getElementById("blockedUsersContainer");
      if (!container) {
        container = document.createElement("div");
        container.id = "blockedUsersContainer";
        container.style.marginTop = "20px";
        container.innerHTML = "<h3>Usuarios Bloqueados</h3>";
        document.getElementById("adminPanel").appendChild(container);
      }
      let snapshot = await db.collection("blockedDevices").get();
      container.innerHTML = "<h3>Usuarios Bloqueados</h3>";
      snapshot.forEach(doc => {
        let data = doc.data();
        const div = document.createElement("div");
        div.style.border = "1px solid #D4AF37";
        div.style.padding = "10px";
        div.style.marginBottom = "10px";
        const lastApp = appointments.filter(app => app.deviceId === data.deviceId && !app.isBreak)
                            .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))[0];
        const lastName = lastApp ? lastApp.name : "No disponible";
        div.innerHTML = `<p><strong>Device ID:</strong> ${data.deviceId}</p>
                         <p><strong>Bloqueado en:</strong> ${data.blockedAt}</p>
                         <p><strong>Última cita:</strong> ${lastName}</p>
                         <p><strong>No shows/cancelaciones:</strong> ${data.cancelCount || data.noShowCount}</p>`;
        if (data.unblockedAt) {
          div.innerHTML += `<p><strong>Desbloqueado en:</strong> ${data.unblockedAt}</p>`;
        }
        const btn = document.createElement("button");
        btn.textContent = "Desbloquear";
        btn.style.backgroundColor = "gray";
        btn.addEventListener("click", async () => {
          await db.collection("blockedDevices").doc(data.deviceId).update({ unblockedAt: new Date().toISOString() });
          alert("Usuario desbloqueado. Podrá agendar citas después de 10 días.");
          renderBlockedUsers();
        });
        div.appendChild(btn);
        container.appendChild(div);
      });
    }
    
    /* ==============================
       Sección: Programar Descansos (Admin) - Mejorado para múltiples descansos
       ============================== */
    document.getElementById("btnTomarDescanso").addEventListener("click", () => showSection("adminBreakSection"));
    
    document.getElementById("adminBreakDate").addEventListener("change", function() {
      const date = this.value;
      selectedBreakSlots = []; // Reset de selección cuando cambia la fecha
      if (date) {
        document.getElementById("adminBreakSelectedDate").textContent = date;
        renderBreakAvailableHours(date);
      } else {
        document.getElementById("breakHoursSection").classList.add("hidden");
      }
    });
    
    function renderBreakAvailableHours(date) {
      const container = document.getElementById("breakHoursContainer");
      container.innerHTML = "";
      const now = new Date();
      const todayStr = getLocalDateString(new Date());
      const selectedDateObj = parseLocalDate(date);
      const todayObj = parseLocalDate(todayStr);
      const slots = generateTimeSlots("09:30", "12:30", 30).concat(generateTimeSlots("15:00", "19:30", 30));
      
      slots.forEach(hour => {
        const [h, m] = hour.split(":").map(Number);
        const slotTime = new Date(selectedDateObj.getFullYear(), selectedDateObj.getMonth(), selectedDateObj.getDate(), h, m, 0);
        const normalApp = appointments.find(app => app.date === date && app.time === hour && !app.isBreak);
        const breakApp = appointments.find(app => app.date === date && app.time === hour && app.isBreak === true);
        let btn = document.createElement("button");
        
        // Determinar si el slot ya pasó o está inválido
        if (selectedDateObj < todayObj || (date === todayStr && (now > slotTime || now > new Date(slotTime.getTime() - 15 * 60 * 1000)))) {
          btn.disabled = true;
          btn.style.textDecoration = "line-through";
          btn.style.color = "gray";
          btn.textContent = hour + " (No disponible)";
        } else if (normalApp) {
          btn.disabled = true;
          btn.style.textDecoration = "line-through";
          btn.style.color = "gray";
          btn.textContent = hour + " (No disponible)";
        } else if (breakApp) {
          // Si ya hay un descanso programado en ese slot, el botón permitirá cancelarlo
          btn.textContent = hour + " - Bloqueado";
          btn.addEventListener("click", async () => {
            if (confirm("¿Desea cancelar el descanso programado para " + hour + " del " + date + "?")) {
              await db.collection("appointments").doc(breakApp.id).delete();
              alert("Descanso cancelado, la hora ha sido habilitada.");
              renderBreakAvailableHours(date);
            }
          });
        } else {
          // Slot disponible para selección múltiple
          btn.textContent = hour;
          // Si ya está seleccionado, lo marcamos visualmente
          if (selectedBreakSlots.includes(hour)) {
            btn.classList.add("selected");
          }
          btn.addEventListener("click", function() {
            if (selectedBreakSlots.includes(hour)) {
              // Des-seleccionar
              selectedBreakSlots = selectedBreakSlots.filter(item => item !== hour);
              this.classList.remove("selected");
            } else {
              // Seleccionar
              selectedBreakSlots.push(hour);
              this.classList.add("selected");
            }
          });
        }
        container.appendChild(btn);
      });
      document.getElementById("breakHoursSection").classList.remove("hidden");
    }
    
    // Confirmar múltiples descansos seleccionados
    document.getElementById("confirmBreaksBtn").addEventListener("click", () => {
      const date = document.getElementById("adminBreakDate").value;
      if (!date) {
        alert("Por favor seleccione una fecha.");
        return;
      }
      if (selectedBreakSlots.length === 0) {
        alert("No ha seleccionado ninguna franja horaria.");
        return;
      }
      selectedBreakSlots.forEach(hour => {
        const newBreak = {
          name: "Descanso",
          date: date,
          time: hour,
          products: [],
          cutType: "Descanso",
          phone: "",
          monto: 0,
          estatus: "Descanso",
          isBreak: true,
          createdAt: new Date().toISOString(),
          deviceId: deviceId
        };
        addAppointment(newBreak);
      });
      alert(`Se han programado ${selectedBreakSlots.length} descansos para el ${date}.`);
      selectedBreakSlots = [];
      renderBreakAvailableHours(date);
    });
    
    document.getElementById("btnAdminBreakBack").addEventListener("click", () => showSection("adminPanel"));
    
    /* ==============================
       Exportación a Excel usando SheetJS
       ============================== */
    document.getElementById("btnVisitCount").addEventListener("click", async () => {
      // Filtrar solo las citas atendidas (consideramos "Vino" o "Corte Terminado" como cortes efectivos)
      const attendedApps = appointments.filter(
        app => app.estatus === "Vino" || app.estatus === "Corte Terminado"
      );
    
      // Agrupar las citas por día y calcular totales
      const dataByDate = {};
      attendedApps.forEach(app => {
        const date = app.date;
        if (!dataByDate[date]) {
          dataByDate[date] = {
            Fecha: date,
            "Total Cortes": 0,
            "Dinero en Cortes": 0,
            "Dinero en Productos": 0,
            "Total Productos": 0,
            productosTemp: {}
          };
        }
        const servicePrice = servicePrices[app.cutType] || 0;
        const productPrice = app.products && Array.isArray(app.products)
          ? app.products.reduce((sum, p) => sum + (productPrices[p] || 0), 0)
          : 0;
    
        dataByDate[date]["Total Cortes"] += 1;
        dataByDate[date]["Dinero en Cortes"] += servicePrice;
        dataByDate[date]["Dinero en Productos"] += productPrice;
        dataByDate[date]["Total Productos"] += (app.products ? app.products.length : 0);
    
        // Contar productos individualmente para detalle
        if (app.products && Array.isArray(app.products)) {
          app.products.forEach(prod => {
            dataByDate[date].productosTemp[prod] = (dataByDate[date].productosTemp[prod] || 0) + 1;
          });
        }
      });
    
      // Convertir la información agrupada a un arreglo de objetos para SheetJS
      const outputData = [];
      Object.keys(dataByDate).sort().forEach(date => {
        let dayData = dataByDate[date];
        let detalle = "";
        for (let prod in dayData.productosTemp) {
          detalle += `${prod}: ${dayData.productosTemp[prod]}; `;
        }
        dayData["Detalle de Productos"] = detalle;
        outputData.push({
          Fecha: dayData.Fecha,
          "Total Cortes": dayData["Total Cortes"],
          "Dinero en Cortes": dayData["Dinero en Cortes"],
          "Dinero en Productos": dayData["Dinero en Productos"],
          "Total Productos": dayData["Total Productos"],
          "Detalle de Productos": dayData["Detalle de Productos"]
        });
      });
    
      // Crear hoja y libro de Excel
      const worksheet = XLSX.utils.json_to_sheet(outputData);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Reporte");
      // Descargar archivo Excel
      XLSX.writeFile(workbook, "reporte.xlsx");
    });
  </script>
</body>
</html>