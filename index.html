<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR-BARBER</title>
  
  <!-- Font Awesome para íconos -->
  <link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free@6.4.0/css/all.css">
  
  <!-- Firebase (versión compat para la forma clásica) -->
  <!-- For Firebase JS SDK v7.20.0 and later, measurementId is optional -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAuCecYVh9CiAlW6dWNrZuzuLq2DETtq1k",
      authDomain: "ar-barber.firebaseapp.com",
      projectId: "ar-barber",
      storageBucket: "ar-barber.firebasestorage.app",
      messagingSenderId: "663202339677",
      appId: "1:663202339677:web:441b1abf0d0ff5034966b4",
      measurementId: "G-3WBEMN22HX"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
  
  <style>
    /* Reset y básicas */
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #121212;
      color: #fff;
    }
    /* Header moderno y centralizado */
    header {
      background: #000;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      border-bottom: 2px solid #D4AF37;
    }
    header img { max-height: 80px; }
    header h1 { margin: 0; color: #D4AF37; font-size: 2em; }
    nav {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    nav button {
      background: #D4AF37;
      color: #121212;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.3s;
      min-width: 120px;
      text-align: center;
    }
    nav button:hover { background: #b0892c; }
    /* Contenedor principal */
    .container {
      width: 90%;
      max-width: 1200px;
      margin: auto;
      padding: 20px 0;
    }
    /* Secciones con fondo y sombra */
    section {
      background: #1e1e1e;
      padding: 30px;
      margin: 20px 0;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    .hidden { display: none; }
    /* Formularios y campos */
    form {
      background: #2c2c2c;
      padding: 20px;
      border: 1px solid #D4AF37;
      border-radius: 10px;
      max-width: 500px;
      margin: auto;
    }
    form input, form button, form select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 1em;
      border: 1px solid #D4AF37;
      border-radius: 5px;
      background: #121212;
      color: #fff;
    }
    fieldset {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #D4AF37;
      border-radius: 10px;
    }
    fieldset legend { padding: 0 10px; }
    /* Contenedor de horas */
    .hours-container {
      margin: 15px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .hours-container button {
      width: 80px;
      font-size: 0.9em;
      padding: 8px;
      border: 1px solid #D4AF37;
      border-radius: 5px;
      background: #121212;
      color: #fff;
      transition: background 0.3s;
    }
    .hours-container button.selected {
      background: #D4AF37;
      color: #121212;
    }
    .hours-container button[disabled] {
      text-decoration: line-through;
      color: gray;
    }
    #btnAcceptAppointment {
      background: #D4AF37;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      color: #121212;
      font-size: 1em;
      cursor: pointer;
      margin-top: 15px;
    }
    #btnAcceptAppointment:disabled { background: #444; cursor: not-allowed; }
    /* Área de inicio */
    .home-container {
      text-align: center;
      padding: 30px;
      background: linear-gradient(45deg, #000, #333);
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    .home-container h2 { color: #D4AF37; font-size: 2.5em; margin-bottom: 10px; }
    .home-container p { font-size: 1.2em; margin-bottom: 10px; }
    .contact-info p { margin: 5px; font-size: 1em; }
    /* Redes sociales: forzamos inline-flex para que el icono y texto queden en una sola línea */
    .contact-info a {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: #D4AF37;
      text-decoration: none;
      font-weight: bold;
      margin: 0 10px;
    }
    .contact-info a:hover { text-decoration: underline; }
    
    /* Estilos para la sección "Mis Citas" */
    #userAppointments {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.5);
    }
    #userAppointments h2 {
      text-align: center;
      color: #D4AF37;
    }
    .user-appointment {
      background: #121212;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #D4AF37;
      border-radius: 5px;
    }
    
    /* Modal de edición */
    #editModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #editModal .modal-content {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.8);
    }
    /* Panel de Administración (cuadros de status) */
    .status-group {
      background: #2c2c2c;
      border: 1px solid #D4AF37;
      border-radius: 10px;
      padding: 20px;
      width: 100%;
      max-width: 350px;
      margin: 10px;
    }
    .status-group h3 {
      margin-bottom: 15px;
      color: #D4AF37;
      text-align: center;
    }
    .appointment {
      background: #121212;
      padding: 15px;
      border: 1px solid #D4AF37;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .appointment p { margin: 5px 0; font-size: 0.95em; }
    .estatus-proximo { color: yellow; font-weight: bold; }
    .estatus-pendiente { color: red; font-weight: bold; }
    .estatus-finalizado { color: green; font-weight: bold; }
  </style>
</head>
<body>
  <header>
    <img src="imagen.jpg" alt="Logo de AR-BARBER">
    <h1>AR-BARBER</h1>
    <nav>
      <button id="btnHome">Inicio</button>
      <button id="btnClient">Agendar Cita</button>
      <button id="btnUserAppointments">Mis Citas</button>
      <button id="btnAdmin">Administrador</button>
    </nav>
  </header>
  
  <div class="container">
    <!-- Sección de Inicio -->
    <section id="home">
      <div class="home-container">
        <h2>Bienvenido a AR-BARBER</h2>
        <p>
          Transforma tu imagen con nuestro toque personal. Con pasión y dedicación te ayudamos a descubrir tu mejor versión. ¡Vive la experiencia y siente la diferencia en cada corte!
        </p>
        <div class="contact-info">
          <p><strong>Contacto:</strong> Tel: 6688366047 | 6683241804 | Email: info@elestilobarberia.com</p>
          <p>
            <a href="https://instagram.com" target="_blank"><i class="fab fa-instagram"></i> Instagram</a>
            <a href="https://wa.me/6688366047" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a>
            <a href="https://facebook.com" target="_blank"><i class="fab fa-facebook-f"></i> Facebook</a>
          </p>
        </div>
      </div>
    </section>
    
    <!-- Sección de Cliente -->
    <section id="clientSection" class="hidden">
      <h2>Reservar Cita</h2>
      <form id="clientForm">
        <label for="clientName">Nombre y Apellido:</label>
        <input type="text" id="clientName" required>
        
        <!-- Nuevo campo: Número de WhatsApp o celular -->
        <label for="clientPhone">Número de WhatsApp:</label>
        <input type="tel" id="clientPhone" required>
        
        <label for="clientDate">Seleccione un día:</label>
        <input type="date" id="clientDate" required>
        
        <label for="cutType">Servicio:</label>
        <select id="cutType" required>
          <option value="">--Seleccione un servicio--</option>
          <option value="corte">Corte de cabello ($120)</option>
          <option value="barba">Barba ($100)</option>
          <option value="ceja">Ceja ($30)</option>
          <option value="marcado">Marcado ($70)</option>
          <option value="corte_barba">Corte y barba (Combo) ($200)</option>
          <option value="corte_cera">Corte y cera (Combo) ($220)</option>
          <option value="barba_aceite">Barba y aceite (Combo) ($220)</option>
          <option value="corte_barba_aceite">Corte, barba y aceite (Combo) ($320)</option>
        </select>
        <fieldset>
          <legend>Productos disponibles:</legend>
          <input type="checkbox" id="product1" value="Cera">
          <label for="product1">Cera ($120)</label><br>
          <input type="checkbox" id="product2" value="Aceite p/barba">
          <label for="product2">Aceite p/barba ($150)</label><br>
          <input type="checkbox" id="product3" value="Monóxidil">
          <label for="product3">Monóxidil ($300)</label><br>
          <input type="checkbox" id="product4" value="Shampoo">
          <label for="product4">Shampoo ($250)</label><br>
          <input type="checkbox" id="product5" value="Gel c/tinte">
          <label for="product5">Gel c/tinte ($100)</label><br>
        </fieldset>
        <button type="submit">Continuar</button>
      </form>
      
      <div id="hoursSection" class="hidden">
        <h3>Horas disponibles para <span id="selectedDate"></span>:</h3>
        <div class="hours-container" id="hoursContainer"></div>
        <button id="btnAcceptAppointment" disabled>Aceptar cita</button>
      </div>
      <div id="clientMessage"></div>
      <button id="btnClientBack">Volver</button>
    </section>
    
    <!-- Sección de "Mis Citas" (vista por dispositivo) -->
    <section id="userAppointments" class="hidden">
      <h2>Mis Citas</h2>
      <div id="userAppointmentsContainer"></div>
      <button id="btnUserAppointmentsBack">Volver</button>
    </section>
    
    <!-- Sección de Login del Administrador -->
    <section id="adminLogin" class="hidden">
      <h2>Acceso Administrador</h2>
      <form id="loginForm">
        <label for="adminUser">Usuario:</label>
        <input type="text" id="adminUser" required>
        <label for="adminPass">Contraseña:</label>
        <input type="password" id="adminPass" required>
        <button type="submit">Ingresar</button>
      </form>
      <div id="loginMessage"></div>
      <button id="btnAdminBack">Volver</button>
    </section>
    
    <!-- Panel de Administración -->
    <section id="adminPanel" class="hidden">
      <h2>Panel de Administración</h2>
      <div id="adminContainer"></div>
      <button id="btnFinalizarCorte">Finalizar Corte</button>
      <div id="totalCorte"></div>
      <button id="btnVisitCount">Ver Conteo de Visitas</button>
      <button id="btnAdminExit">Cerrar sesión</button>
    </section>
  </div>
  
  <!-- Modal para Modificar Cita (Administrador/Cliente) -->
  <!-- Se mantiene el modal para edición, que será usado tanto por administradores como por clientes -->
  <div id="editModal" class="hidden">
    <div class="modal-content">
      <h2>Modificar Cita</h2>
      <form id="editForm">
        <label for="editDate">Fecha:</label>
        <input type="date" id="editDate" required>
        <label for="editTime">Hora:</label>
        <select id="editTime" required>
          <option value="">--Seleccione la hora--</option>
          <!-- Opciones generadas dinámicamente -->
        </select>
        <label for="editCutType">Servicio:</label>
        <select id="editCutType" required>
          <option value="">--Seleccione un servicio--</option>
          <option value="corte">Corte de cabello ($120)</option>
          <option value="barba">Barba ($100)</option>
          <option value="ceja">Ceja ($30)</option>
          <option value="marcado">Marcado ($70)</option>
          <option value="corte_barba">Corte y barba (Combo) ($200)</option>
          <option value="corte_cera">Corte y cera (Combo) ($220)</option>
          <option value="barba_aceite">Barba y aceite (Combo) ($220)</option>
          <option value="corte_barba_aceite">Corte, barba y aceite (Combo) ($320)</option>
        </select>
        <fieldset>
          <legend>Productos disponibles:</legend>
          <input type="checkbox" id="editProduct1" value="Cera">
          <label for="editProduct1">Cera ($120)</label><br>
          <input type="checkbox" id="editProduct2" value="Aceite p/barba">
          <label for="editProduct2">Aceite p/barba ($150)</label><br>
          <input type="checkbox" id="editProduct3" value="Monóxidil">
          <label for="editProduct3">Monóxidil ($300)</label><br>
          <input type="checkbox" id="editProduct4" value="Shampoo">
          <label for="editProduct4">Shampoo ($250)</label><br>
          <input type="checkbox" id="editProduct5" value="Gel c/tinte">
          <label for="editProduct5">Gel c/tinte ($100)</label><br>
        </fieldset>
        <div class="modal-buttons">
          <button type="button" id="saveChanges">Guardar cambios</button>
          <button type="button" id="deleteAppointment" style="background:#FF0000;">Cancelar cita</button>
        </div>
        <button type="button" id="closeEditModal" style="margin-top:10px;">Cerrar</button>
      </form>
    </div>
  </div>
  
  <script>
    // --- Generación de un identificador único de dispositivo ---
    let deviceId = localStorage.getItem("deviceId");
    if (!deviceId) {
      deviceId = "device_" + Math.random().toString(36).substr(2, 9);
      localStorage.setItem("deviceId", deviceId);
    }
    
    // Definición de precios
    const servicePrices = {
      "corte": 120,
      "barba": 100,
      "ceja": 30,
      "marcado": 70,
      "corte_barba": 200,
      "corte_cera": 220,
      "barba_aceite": 220,
      "corte_barba_aceite": 320
    };
    const productPrices = {
      "Cera": 120,
      "Aceite p/barba": 150,
      "Monóxidil": 300,
      "Shampoo": 250,
      "Gel c/tinte": 100
    };
    
    // Credenciales de administrador (simples)
    const adminCredentials = { user: "admin", pass: "admin123" };
    
    let appointments = []; // Se rellenará en tiempo real desde Firestore
    let clientData = {};
    let selectedHour = null;
    let currentEditingIndex = null;
    
    // Sincronización en tiempo real de la colección "appointments" en Firestore
    db.collection("appointments").onSnapshot((snapshot) => {
      appointments = [];
      snapshot.forEach(doc => {
        let data = doc.data();
        data.id = doc.id;
        appointments.push(data);
      });
      // Actualizamos el panel de administración y "Mis Citas" si están visibles.
      if (!document.getElementById("adminPanel").classList.contains("hidden")) {
        renderAdminPanel();
      }
      if (!document.getElementById("userAppointments").classList.contains("hidden")) {
        renderUserAppointments();
      }
    });
    
    // Función para mostrar la sección deseada y ocultar las demás
    function showSection(sectionId) {
      document.querySelectorAll("section").forEach(section => section.classList.add("hidden"));
      document.getElementById(sectionId).classList.remove("hidden");
    }
    
    // Navegación
    document.getElementById("btnHome").addEventListener("click", () => showSection("home"));
    document.getElementById("btnClient").addEventListener("click", () => {
      document.getElementById("clientForm").reset();
      document.getElementById("clientMessage").textContent = "";
      document.getElementById("hoursSection").classList.add("hidden");
      selectedHour = null;
      showSection("clientSection");
    });
    document.getElementById("btnClientBack").addEventListener("click", () => showSection("home"));
    document.getElementById("btnAdmin").addEventListener("click", () => showSection("adminLogin"));
    document.getElementById("btnAdminBack").addEventListener("click", () => showSection("home"));
    
    // Navegación para "Mis Citas"
    document.getElementById("btnUserAppointments").addEventListener("click", () => {
      renderUserAppointments();
      showSection("userAppointments");
    });
    document.getElementById("btnUserAppointmentsBack").addEventListener("click", () => showSection("home"));
    
    // Función para consultar si el dispositivo está bloqueado
    async function isDeviceBlocked() {
      const blockDoc = await db.collection("blockedDevices").doc(deviceId).get();
      if (blockDoc.exists) {
        const data = blockDoc.data();
        if (!data.unblockedAt) {
          return true;
        } else {
          let unblockedAt = new Date(data.unblockedAt);
          let now = new Date();
          let diff = now - unblockedAt;
          let tenDays = 10 * 24 * 60 * 60 * 1000;
          if (diff < tenDays) return true;
          else return false;
        }
      }
      return false;
    }
    
    // Renderizado de las horas disponibles para la reserva
    function renderAvailableHours(date) {
      const hoursContainer = document.getElementById("hoursContainer");
      hoursContainer.innerHTML = "";
      selectedHour = null;
      const hours = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
      const todayStr = new Date().toISOString().split("T")[0];
      // Si la fecha seleccionada ya fue pasada
      const isPastDate = date < todayStr;
      
      hours.forEach(hour => {
        // Se consideran reservadas únicamente las citas activas (no canceladas)
        const isBooked = appointments.some(app => app.date === date && app.time === hour && app.estatus !== "Cita cancelada por el administrador" && app.estatus !== "Cita cancelada por el cliente");
        const button = document.createElement("button");
        button.textContent = hour;
        if (isBooked || isPastDate || (date === todayStr && new Date() > new Date(date + "T" + hour))) {
          button.disabled = true;
          button.style.textDecoration = "line-through";
          button.style.color = "gray";
        } else {
          button.addEventListener("click", function() {
            const btns = hoursContainer.querySelectorAll("button");
            btns.forEach(btn => btn.classList.remove("selected"));
            this.classList.add("selected");
            selectedHour = hour;
            document.getElementById("btnAcceptAppointment").disabled = false;
          });
        }
        hoursContainer.appendChild(button);
      });
    }
    
    // Agregar cita en Firestore
    async function addAppointment(appointment) {
      try {
        await db.collection("appointments").add(appointment);
      } catch (error) {
        console.error("Error agregando la cita:", error);
      }
    }
    
    // Manejo del formulario del cliente (ahora con verificación de bloqueo)
    document.getElementById("clientForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      if (await isDeviceBlocked()) {
        document.getElementById("clientMessage").textContent = "Este dispositivo está bloqueado de agendar citas. Contacta al administrador.";
        return;
      }
      const name = document.getElementById("clientName").value;
      const date = document.getElementById("clientDate").value;
      const phone = document.getElementById("clientPhone").value; // Nuevo campo
      const cutType = document.getElementById("cutType").value;
      const selectedProducts = Array.from(document.querySelectorAll("#clientForm input[type=checkbox]:checked"))
                                   .map(product => product.value);
      
      if (!date) {
        document.getElementById("clientMessage").textContent = "Debe seleccionar una fecha.";
        return;
      }
      if (!cutType) {
        document.getElementById("clientMessage").textContent = "Debe seleccionar el servicio.";
        return;
      }
      clientData = { name, date, phone, selectedProducts, cutType };
      document.getElementById("selectedDate").textContent = date;
      document.getElementById("hoursSection").classList.remove("hidden");
      renderAvailableHours(date);
      document.getElementById("btnAcceptAppointment").disabled = true;
    });
    
    document.getElementById("btnAcceptAppointment").addEventListener("click", function() {
      if (!selectedHour) return;
      // Agregar el nuevo parámetro "phone"
      reserveHour(clientData.name, clientData.date, selectedHour, clientData.selectedProducts, clientData.cutType, clientData.phone);
      document.getElementById("clientForm").reset();
      clientData = {};
      selectedHour = null;
    });
    
    // Reserva de cita: calcula precio, añade deviceId y lo agrega en Firestore.
    // Se muestra la confirmación por 10 segundos antes de ir a inicio.
    function reserveHour(name, date, hour, products, cutType, phone) {
      let price = servicePrices[cutType] || 0;
      products.forEach(product => { price += productPrices[product] || 0; });
      const newAppointment = {
        name,
        date,
        time: hour,
        products,
        cutType,
        phone, // Se almacena el número de WhatsApp o celular
        monto: price,
        estatus: "Próximo corte",
        createdAt: new Date().toISOString(),
        deviceId: deviceId
      };
      addAppointment(newAppointment);
      document.getElementById("clientMessage").textContent =
        `Cita reservada para el ${date} a las ${hour}. Servicio: ${cutType}. Productos: ${products.join(", ") || "Ninguno"}. Precio: $${price}.`;
      renderAvailableHours(date);
      setTimeout(() => { showSection("home"); }, 10000);
    }
    
    // Login del administrador
    document.getElementById("loginForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const user = document.getElementById("adminUser").value;
      const pass = document.getElementById("adminPass").value;
      if (user === adminCredentials.user && pass === adminCredentials.pass) {
        showSection("adminPanel");
        renderAdminPanel();
      } else {
        document.getElementById("loginMessage").textContent = "Usuario o contraseña incorrectos.";
      }
    });
    
    document.getElementById("btnAdminExit").addEventListener("click", () => {
      document.getElementById("adminUser").value = "";
      document.getElementById("adminPass").value = "";
      document.getElementById("loginMessage").textContent = "";
      showSection("home");
    });
    
    // Función para renderizar las citas generadas por el dispositivo (Mis Citas)
    // En esta vista el cliente puede editar o cancelar su cita.
    function createUserAppointmentElement(app) {
      const container = document.createElement("div");
      container.classList.add("user-appointment");
      if(app.estatus === "Cita cancelada por el administrador" || app.estatus === "Cita cancelada por el cliente") {
        container.innerHTML = `
          <p><strong>Cita Cancelada</strong></p>
          <p><strong>Fecha de la cita:</strong> ${app.date}</p>
          <p><strong>Fecha de cancelación:</strong> ${app.canceledAt || "No especificado"}</p>
        `;
        return container;
      }
      container.innerHTML = `
        <p><strong>Nombre:</strong> ${app.name}</p>
        <p><strong>Teléfono:</strong> ${app.phone || "No especificado"}</p>
        <p><strong>Fecha:</strong> ${app.date}</p>
        <p><strong>Hora:</strong> ${app.time}</p>
        <p><strong>Servicio:</strong> ${app.cutType || "Sin especificar"}</p>
        <p><strong>Productos:</strong> ${(app.products && app.products.length > 0) ? app.products.join(", ") : "Ninguno"}</p>
        <p><strong>Ingreso:</strong> $${app.monto}</p>
        <p><strong>Estatus:</strong> ${app.estatus}</p>
      `;
      // Botón Editar cita: solo habilitado si faltan 2 horas o más
      const btnEdit = document.createElement("button");
      btnEdit.textContent = "Editar cita";
      const appointmentDateTime = new Date(app.date + "T" + app.time);
      const diffHours = (appointmentDateTime - new Date()) / (3600 * 1000);
      if (diffHours < 2) {
        btnEdit.disabled = true;
        btnEdit.title = "No se puede editar la cita menos de 2 horas antes.";
      }
      btnEdit.addEventListener("click", function() {
        openEditModalForClient(app);
      });
      container.appendChild(btnEdit);
      
      // Botón Cancelar cita (cliente)
      const btnCancel = document.createElement("button");
      btnCancel.textContent = "Cancelar cita";
      btnCancel.style.marginLeft = "5px";
      btnCancel.addEventListener("click", function() {
        cancelClientAppointment(app);
      });
      container.appendChild(btnCancel);
      
      return container;
    }
    
    // Función para renderizar "Mis Citas" para el cliente
    function renderUserAppointments() {
      const userAppointmentsContainer = document.getElementById("userAppointmentsContainer");
      userAppointmentsContainer.innerHTML = "";
      const userAppointments = appointments.filter(app => app.deviceId === deviceId);
      if (userAppointments.length === 0) {
        userAppointmentsContainer.innerHTML = "<p>No tienes citas registradas en este dispositivo.</p>";
        return;
      }
      userAppointments.forEach(app => {
        const elem = createUserAppointmentElement(app);
        userAppointmentsContainer.appendChild(elem);
      });
    }
    
    // Funciones para Modal de Edición (usado tanto por administradores como por clientes)
    function updateEditTimeOptions(selectedDate, currentTimeSelection) {
      const editTimeSelect = document.getElementById("editTime");
      editTimeSelect.innerHTML = "";
      const hours = ["09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00", "17:00"];
      const todayStr = new Date().toISOString().split("T")[0];
      hours.forEach(hour => {
        let isBooked = appointments.some((app, index) => {
          if(index == currentEditingIndex) return false;
          return app.date === selectedDate && app.time === hour && app.estatus !== "Cita cancelada por el administrador" && app.estatus !== "Cita cancelada por el cliente";
        });
        const option = document.createElement("option");
        option.value = hour;
        option.textContent = hour;
        if (isBooked || (selectedDate === todayStr && new Date() > new Date(selectedDate + "T" + hour))) {
          option.disabled = true;
        } else if (hour === currentTimeSelection) {
          option.selected = true;
        }
        editTimeSelect.appendChild(option);
      });
    }
    
    // Función para abrir el modal de edición y cargar los datos de la cita
    function openEditModalForClient(app) {
      currentEditingIndex = appointments.findIndex(a => a.id === app.id);
      // Rellenar campos del formulario en el modal
      document.getElementById("editDate").value = app.date;
      updateEditTimeOptions(app.date, app.time);
      document.getElementById("editCutType").value = app.cutType;
      // Reiniciar checkboxes de productos
      const productIds = ["editProduct1", "editProduct2", "editProduct3", "editProduct4", "editProduct5"];
      productIds.forEach(id => { document.getElementById(id).checked = false; });
      (app.products || []).forEach(prod => {
        if(prod === "Cera"){
          document.getElementById("editProduct1").checked = true;
        }
        if(prod === "Aceite p/barba"){
          document.getElementById("editProduct2").checked = true;
        }
        if(prod === "Monóxidil"){
          document.getElementById("editProduct3").checked = true;
        }
        if(prod === "Shampoo"){
          document.getElementById("editProduct4").checked = true;
        }
        if(prod === "Gel c/tinte"){
          document.getElementById("editProduct5").checked = true;
        }
      });
      // Mostrar el modal
      document.getElementById("editModal").style.display = "flex";
    }
    
    // Evento para guardar cambios en el modal de edición
    document.getElementById("saveChanges").addEventListener("click", async function() {
      let updatedDate = document.getElementById("editDate").value;
      let updatedTime = document.getElementById("editTime").value;
      let updatedCutType = document.getElementById("editCutType").value;
      let updatedProducts = Array.from(document.querySelectorAll("#editForm input[type=checkbox]:checked"))
                                .map(cb => cb.value);
      let updateObj = {
        date: updatedDate,
        time: updatedTime,
        cutType: updatedCutType,
        products: updatedProducts
      };
      let app = appointments[currentEditingIndex];
      await db.collection("appointments").doc(app.id).update(updateObj);
      document.getElementById("editModal").style.display = "none";
    });
    
    // Evento para cancelar (eliminar) una cita desde el modal
    document.getElementById("deleteAppointment").addEventListener("click", async function() {
      if (confirm("¿Estás seguro de que deseas cancelar esta cita?")) {
        let app = appointments[currentEditingIndex];
        await db.collection("appointments").doc(app.id).update({
          estatus: "Cita cancelada por el cliente",
          canceledAt: new Date().toISOString()
        });
        document.getElementById("editModal").style.display = "none";
      }
    });
    
    // Cerrar modal de edición
    document.getElementById("closeEditModal").addEventListener("click", function() {
      document.getElementById("editModal").style.display = "none";
    });
    
    // Función para cancelar una cita desde "Mis Citas"
    async function cancelClientAppointment(app) {
      if(confirm("¿Estás seguro de que deseas cancelar tu cita?")) {
        await db.collection("appointments").doc(app.id).update({
          estatus: "Cita cancelada por el cliente",
          canceledAt: new Date().toISOString()
        });
      }
    }
    
    // Función para generar el elemento de cita en el panel de administración
    function createAppointmentElement(app, index) {
      const container = document.createElement("div");
      container.classList.add("appointment");
      container.innerHTML = `
        <p><strong>Nombre:</strong> ${app.name}</p>
        <p><strong>Teléfono:</strong> ${app.phone || "No especificado"}</p>
        <p><strong>Fecha:</strong> ${app.date}</p>
        <p><strong>Hora:</strong> ${app.time}</p>
        <p><strong>Servicio:</strong> ${app.cutType || "Sin especificar"}</p>
        <p><strong>Productos:</strong> ${(app.products && app.products.length > 0) ? app.products.join(", ") : "Ninguno"}</p>
        <p><strong>Ingreso:</strong> $${app.monto}</p>
        <p><strong>Estatus:</strong> ${app.estatus}</p>
      `;
      // Si la cita está en estado "Próximo corte" se agregan botones para acciones del admin
      if (app.estatus === "Próximo corte") {
        const btnVino = document.createElement("button");
        btnVino.innerHTML = '<i class="fas fa-check"></i>';
        btnVino.classList.add("btnVino");
        btnVino.setAttribute("data-index", index);
        btnVino.title = "Marcar como Asistió";
        container.appendChild(btnVino);
        
        const btnNoVino = document.createElement("button");
        btnNoVino.innerHTML = '<i class="fas fa-times"></i>';
        btnNoVino.classList.add("btnNoVino");
        btnNoVino.setAttribute("data-index", index);
        btnNoVino.style.marginLeft = "5px";
        btnNoVino.title = "Marcar como No Asistió";
        container.appendChild(btnNoVino);
        
        const btnCancelAdmin = document.createElement("button");
        btnCancelAdmin.innerHTML = '<i class="fas fa-ban"></i>';
        btnCancelAdmin.classList.add("btnCancelAdmin");
        btnCancelAdmin.setAttribute("data-index", index);
        btnCancelAdmin.style.marginLeft = "5px";
        btnCancelAdmin.title = "Cancelar cita (administrador)";
        container.appendChild(btnCancelAdmin);
        
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar cita";
        btnEditar.style.marginLeft = "5px";
        btnEditar.addEventListener("click", function() {
          openEditModalForClient(app);
        });
        container.appendChild(btnEditar);
      }
      return container;
    }
    
    function renderAdminPanel() {
      const adminContainer = document.getElementById("adminContainer");
      adminContainer.innerHTML = "";
      
      // Usamos cuadros con la clase "status-group" para cada estado
      const groupProximo = document.createElement("div");
      groupProximo.classList.add("status-group");
      groupProximo.innerHTML = "<h3>Citas Próximas</h3>";
      
      const groupPendiente = document.createElement("div");
      groupPendiente.classList.add("status-group");
      groupPendiente.innerHTML = "<h3>Citas Pendientes</h3>";
      
      const groupFinalizado = document.createElement("div");
      groupFinalizado.classList.add("status-group");
      groupFinalizado.innerHTML = "<h3>Citas Finalizadas</h3>";
      
      appointments.forEach((app, index) => {
        // Se omiten las citas canceladas
        if (app.estatus === "Cita cancelada por el administrador" || app.estatus === "Cita cancelada por el cliente") {
          return;
        }
        const appDateTime = new Date(app.date + "T" + app.time);
        if (app.estatus === "Próximo corte" && appDateTime < new Date()) {
          app.estatus = "Corte no realizado";
          db.collection("appointments").doc(app.id).update({ estatus: "Corte no realizado" });
        }
        const appointmentElement = createAppointmentElement(app, index);
        if (app.estatus === "Próximo corte") {
          groupProximo.appendChild(appointmentElement);
        } else if (app.estatus === "Corte no realizado" || app.estatus === "No vino") {
          groupPendiente.appendChild(appointmentElement);
        } else if (app.estatus === "Corte Terminado" || app.estatus === "Vino") {
          groupFinalizado.appendChild(appointmentElement);
        }
      });
      
      if (groupProximo.children.length <= 1) {
        const msg = document.createElement("p");
        msg.textContent = "No hay citas próximas.";
        groupProximo.appendChild(msg);
      }
      if (groupPendiente.children.length <= 1) {
        const msg = document.createElement("p");
        msg.textContent = "No hay citas pendientes.";
        groupPendiente.appendChild(msg);
      }
      if (groupFinalizado.children.length <= 1) {
        const msg = document.createElement("p");
        msg.textContent = "No hay citas terminadas.";
        groupFinalizado.appendChild(msg);
      }
      
      adminContainer.appendChild(groupProximo);
      adminContainer.appendChild(groupPendiente);
      adminContainer.appendChild(groupFinalizado);
      
      // EVENTOS PARA LOS BOTONES DEL ADMINISTRADOR
      document.querySelectorAll(".btnVino").forEach(button => {
        button.addEventListener("click", async function() {
          const idx = this.getAttribute("data-index");
          let app = appointments[idx];
          app.estatus = "Vino";
          await db.collection("appointments").doc(app.id).update({
            estatus: "Vino"
          });
          alert("Cita marcada como 'Vino'.");
          renderAdminPanel();
        });
      });
      
      document.querySelectorAll(".btnNoVino").forEach(button => {
        button.addEventListener("click", async function() {
          const idx = this.getAttribute("data-index");
          let app = appointments[idx];
          app.estatus = "No vino";
          await db.collection("appointments").doc(app.id).update({
            estatus: "No vino"
          });
          alert("Cita marcada como 'No vino'.");
          // Verificamos si el dispositivo debe ser bloqueado
          checkAndBlockDevice(app.deviceId);
          renderAdminPanel();
        });
      });
      
      document.querySelectorAll(".btnCancelAdmin").forEach(button => {
        button.addEventListener("click", async function() {
          const idx = this.getAttribute("data-index");
          let app = appointments[idx];
          app.estatus = "Cita cancelada por el administrador";
          await db.collection("appointments").doc(app.id).update({
            estatus: "Cita cancelada por el administrador",
            canceledAt: new Date().toISOString()
          });
          alert("Cita cancelada por el administrador.");
          checkAndBlockDevice(app.deviceId);
          renderAdminPanel();
        });
      });
      
      // Renderizamos la sección de Usuarios Bloqueados
      renderBlockedUsers();
    }
    
    // Función para verificar y bloquear el dispositivo si acumula 3 cancelaciones (admin o "No vino")
    async function checkAndBlockDevice(deviceId) {
      let cancelCount = appointments.filter(app => app.deviceId === deviceId && 
          (app.estatus === "No vino" || app.estatus === "Cita cancelada por el administrador")).length;
      if(cancelCount >= 3) {
        const blockRef = db.collection("blockedDevices").doc(deviceId);
        const doc = await blockRef.get();
        if (!doc.exists) {
          await blockRef.set({
            deviceId: deviceId,
            blockedAt: new Date().toISOString(),
            cancelCount: cancelCount,
            status: "blocked"
          });
          alert("El dispositivo ha sido bloqueado por acumular 3 cancelaciones.");
        }
      }
    }
    
    // Función para renderizar la sección de Usuarios Bloqueados en el Administrador
    async function renderBlockedUsers() {
      let blockedContainer = document.getElementById("blockedUsersContainer");
      if(!blockedContainer) {
        blockedContainer = document.createElement("div");
        blockedContainer.id = "blockedUsersContainer";
        blockedContainer.style.marginTop = "20px";
        blockedContainer.innerHTML = "<h3>Usuarios Bloqueados</h3>";
        document.getElementById("adminPanel").appendChild(blockedContainer);
      }
      // Consultamos la colección "blockedDevices"
      let snapshot = await db.collection("blockedDevices").get();
      blockedContainer.innerHTML = "<h3>Usuarios Bloqueados</h3>";
      snapshot.forEach(doc => {
        let data = doc.data();
        const userDiv = document.createElement("div");
        userDiv.style.border = "1px solid #D4AF37";
        userDiv.style.padding = "10px";
        userDiv.style.marginBottom = "10px";
        userDiv.innerHTML = `<p><strong>Device ID:</strong> ${data.deviceId}</p>
                             <p><strong>Bloqueado en:</strong> ${data.blockedAt}</p>
                             <p><strong>No shows/cancelaciones:</strong> ${data.cancelCount || data.noShowCount}</p>`;
        if(data.unblockedAt) {
          userDiv.innerHTML += `<p><strong>Desbloqueado en:</strong> ${data.unblockedAt}</p>`;
        }
        const btnUnblock = document.createElement("button");
        btnUnblock.textContent = "Desbloquear";
        btnUnblock.style.backgroundColor = "#4CAF50";
        btnUnblock.style.border = "none";
        btnUnblock.style.padding = "5px 10px";
        btnUnblock.style.borderRadius = "3px";
        btnUnblock.style.color = "#fff";
        btnUnblock.addEventListener("click", async function() {
          await db.collection("blockedDevices").doc(data.deviceId).update({
              unblockedAt: new Date().toISOString()
          });
          alert("Usuario desbloqueado. Podrá agendar citas después de 10 días.");
          renderBlockedUsers();
        });
        userDiv.appendChild(btnUnblock);
        blockedContainer.appendChild(userDiv);
      });
    }
    
    // Evento para el botón "Ver Conteo de Visitas" que ahora genera y guarda el reporte de hoy de forma permanente
    document.getElementById("btnVisitCount").addEventListener("click", async function() {
      let todayStr = new Date().toISOString().split("T")[0];
      // Filtramos las citas de hoy en base al campo "date"
      let todaysAppointments = appointments.filter(app => app.date === todayStr);
      
      let canceled = todaysAppointments.filter(app => app.estatus === "Cita cancelada por el administrador" || app.estatus === "Cita cancelada por el cliente");
      // Se ajusta el filtro para incluir "Corte Terminado" en citas asistidas
      let attended = todaysAppointments.filter(app => app.estatus === "Vino" || app.estatus === "Corte Terminado");
      let noShow = todaysAppointments.filter(app => app.estatus === "No vino" || app.estatus === "Corte no realizado");
      
      let totalAttendedMoney = attended.reduce((sum, app) => sum + (parseFloat(app.monto) || 0), 0);
      
      // Construimos el objeto reporte que queremos guardar
      let report = {
        date: todayStr,
        canceled: canceled.map(app => ({
          name: app.name,
          phone: app.phone,
          date: app.date,
          time: app.time,
          service: app.cutType,
          products: app.products,
          status: app.estatus,
          canceledAt: app.canceledAt || null
        })),
        attended: attended.map(app => ({
          name: app.name,
          phone: app.phone,
          date: app.date,
          time: app.time,
          service: app.cutType,
          products: app.products,
          monto: app.monto,
          status: app.estatus
        })),
        noShow: noShow.map(app => ({
          name: app.name,
          phone: app.phone,
          date: app.date,
          time: app.time,
          service: app.cutType,
          products: app.products,
          status: app.estatus
        })),
        totalAttendedMoney: totalAttendedMoney,
        createdAt: new Date().toISOString()
      };
      
      // Guardamos el reporte en Firestore en la colección "reports"
      try {
        await db.collection("reports").add(report);
        console.log("Reporte guardado permanentemente.");
      } catch (error) {
        console.error("Error al guardar el reporte: ", error);
      }
      
      // Generamos HTML para el reporte (estilo Excel)
      let html = "<html><head><title>Reporte de Inventario - " + todayStr + "</title>";
      html += "<style>body { font-family: Arial, sans-serif; background: #fff; color: #000; padding: 20px; }";
      html += "table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }";
      html += "th, td { border: 1px solid #000; padding: 8px; text-align: left; }";
      html += "th { background: #D4AF37; }";
      html += "h2 { margin-top: 40px; }</style></head><body>";
      html += "<h1>Reporte de Inventario - " + todayStr + "</h1>";
      
      // Sección: Citas Canceladas
      html += "<h2>Citas Canceladas</h2>";
      if (canceled.length > 0) {
         html += "<table><tr><th>Cliente</th><th>Teléfono</th><th>Fecha</th><th>Hora</th><th>Servicio</th><th>Productos</th><th>Estado</th></tr>";
         canceled.forEach(app => {
             html += `<tr>
                       <td>${app.name}</td>
                       <td>${app.phone || ""}</td>
                       <td>${app.date}</td>
                       <td>${app.time}</td>
                       <td>${app.cutType}</td>
                       <td>${(app.products && app.products.length > 0) ? app.products.join(", ") : "Ninguno"}</td>
                       <td>${app.estatus}</td>
                       </tr>`;
         });
         html += "</table>";
      } else {
         html += "<p>No hay citas canceladas hoy.</p>";
      }
      
      // Sección: Citas Asistidas
      html += "<h2>Citas Asistidas</h2>";
      if (attended.length > 0) {
         html += "<table><tr><th>Cliente</th><th>Teléfono</th><th>Fecha</th><th>Hora</th><th>Servicio</th><th>Productos</th><th>Monto</th></tr>";
         attended.forEach(app => {
             html += `<tr>
                       <td>${app.name}</td>
                       <td>${app.phone || ""}</td>
                       <td>${app.date}</td>
                       <td>${app.time}</td>
                       <td>${app.cutType}</td>
                       <td>${(app.products && app.products.length > 0) ? app.products.join(", ") : "Ninguno"}</td>
                       <td>$${app.monto}</td>
                       </tr>`;
         });
         html += "</table>";
         html += "<h3>Total dinero en citas asistidas: $" + totalAttendedMoney + "</h3>";
      } else {
         html += "<p>No hay citas asistidas hoy.</p>";
      }
      
      // Sección: Citas No Asistieron
      html += "<h2>Citas No Asistieron</h2>";
      if (noShow.length > 0) {
         html += "<table><tr><th>Cliente</th><th>Teléfono</th><th>Fecha</th><th>Hora</th><th>Servicio</th><th>Productos</th><th>Estado</th></tr>";
         noShow.forEach(app => {
             html += `<tr>
                       <td>${app.name}</td>
                       <td>${app.phone || ""}</td>
                       <td>${app.date}</td>
                       <td>${app.time}</td>
                       <td>${app.cutType}</td>
                       <td>${(app.products && app.products.length > 0) ? app.products.join(", ") : "Ninguno"}</td>
                       <td>${app.estatus}</td>
                       </tr>`;
         });
         html += "</table>";
      } else {
         html += "<p>No hay citas no asistieron hoy.</p>";
      }
      
      html += "</body></html>";
      
      // Abrimos una nueva ventana con el reporte
      let reportWindow = window.open("", "_blank");
      reportWindow.document.write(html);
      reportWindow.document.close();
    });
    
    document.getElementById("btnFinalizarCorte").addEventListener("click", async function() {
      const vinoAppointments = appointments.filter(app => app.estatus === "Vino");
      if(vinoAppointments.length === 0) {
        alert("No hay citas marcadas como 'Vino' para finalizar.");
        return;
      }
      for(let app of vinoAppointments) {
        await db.collection("appointments").doc(app.id).update({
          estatus: "Corte Terminado"
        });
      }
      alert("Se han finalizado los cortes marcados como 'Vino'.");
      renderAdminPanel();
    });
    
    document.getElementById("btnVisitCount").addEventListener("click", function() {
      // El reporte se genera mediante el listener del btnVisitCount arriba.
    });
  </script>
</body>
</html>